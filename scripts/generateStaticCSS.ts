/**
 * é™æ€ CSS æ–‡ä»¶ç”Ÿæˆè„šæœ¬
 * 
 * æ­¤è„šæœ¬ä¸ºæ¯ä¸ª Tokyo Night ä¸»é¢˜å˜ä½“ç”Ÿæˆé™æ€ CSS æ–‡ä»¶ï¼š
 * - theme-night.css (Night å˜ä½“)
 * - theme-storm.css (Storm å˜ä½“) 
 * - theme-light.css (Light å˜ä½“)
 * 
 * ç”Ÿæˆçš„æ–‡ä»¶å°†æ”¾ç½®åœ¨ public ç›®å½•ä¸­ï¼Œä¾› Orca ä¸»é¢˜ç³»ç»Ÿä½¿ç”¨ã€‚
 */

import { writeFileSync, mkdirSync, existsSync, readFileSync } from 'fs';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

// è·å–å½“å‰æ–‡ä»¶çš„ç›®å½•è·¯å¾„
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const projectRoot = join(__dirname, '..');
const publicDir = join(projectRoot, 'public');

// ç”±äº TypeScript ç¼–è¯‘é—®é¢˜ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨è¿™é‡Œå®šä¹‰éœ€è¦çš„ç±»å‹å’Œå‡½æ•°
type ThemeVariant = 'night' | 'storm' | 'light';

// Tokyo Night é¢œè‰²å®šä¹‰
const colorVariants = {
  night: {
    background: {
      primary: '#1a1b26',
      secondary: '#16161e',
      tertiary: '#24283b',
    },
    text: {
      primary: '#a9b1d6',
      secondary: '#9aa5ce',
      muted: '#565f89',
    },
    semantic: {
      red: '#f7768e',
      orange: '#ff9e64',
      yellow: '#e0af68',
      green: '#9ece6a',
      cyan: '#7dcfff',
      blue: '#7aa2f7',
      purple: '#bb9af7',
    },
    ui: {
      border: '#292e42',
      hover: '#414868',
      selection: '#364a82',
      focus: '#7aa2f7',
    }
  },
  storm: {
    background: {
      primary: '#24283b',
      secondary: '#1f2335',
      tertiary: '#292e42',
    },
    text: {
      primary: '#a9b1d6',
      secondary: '#9aa5ce',
      muted: '#565f89',
    },
    semantic: {
      red: '#f7768e',
      orange: '#ff9e64',
      yellow: '#e0af68',
      green: '#9ece6a',
      cyan: '#7dcfff',
      blue: '#7aa2f7',
      purple: '#bb9af7',
    },
    ui: {
      border: '#3b4261',
      hover: '#4a5374',
      selection: '#3d59a1',
      focus: '#7aa2f7',
    }
  },
  light: {
    background: {
      primary: '#d5d6db',
      secondary: '#e9e9ed',
      tertiary: '#ffffff',
    },
    text: {
      primary: '#343b58',
      secondary: '#4f5b93',
      muted: '#6c7394',
    },
    semantic: {
      red: '#8c4351',
      orange: '#965027',
      yellow: '#8f5e15',
      green: '#485e30',
      cyan: '#166775',
      blue: '#34548a',
      purple: '#5a4a78',
    },
    ui: {
      border: '#c4c8da',
      hover: '#b6bbd9',
      selection: '#a8aed6',
      focus: '#34548a',
    }
  }
};

/**
 * ç”Ÿæˆ CSS è‡ªå®šä¹‰å±æ€§å­—ç¬¦ä¸²
 */
function generateCSSCustomProperties(variant: ThemeVariant): string {
  const colors = colorVariants[variant];
  
  return `
  /* Tokyo Night ${variant} å˜ä½“çš„è‡ªå®šä¹‰å±æ€§ */
  --tokyo-night-bg-primary: ${colors.background.primary};
  --tokyo-night-bg-secondary: ${colors.background.secondary};
  --tokyo-night-bg-tertiary: ${colors.background.tertiary};
  
  --tokyo-night-text-primary: ${colors.text.primary};
  --tokyo-night-text-secondary: ${colors.text.secondary};
  --tokyo-night-text-muted: ${colors.text.muted};
  
  --tokyo-night-red: ${colors.semantic.red};
  --tokyo-night-orange: ${colors.semantic.orange};
  --tokyo-night-yellow: ${colors.semantic.yellow};
  --tokyo-night-green: ${colors.semantic.green};
  --tokyo-night-cyan: ${colors.semantic.cyan};
  --tokyo-night-blue: ${colors.semantic.blue};
  --tokyo-night-purple: ${colors.semantic.purple};
  
  --tokyo-night-border: ${colors.ui.border};
  --tokyo-night-hover: ${colors.ui.hover};
  --tokyo-night-selection: ${colors.ui.selection};
  --tokyo-night-focus: ${colors.ui.focus};`;
}

/**
 * ç”Ÿæˆ Orca é¢œè‰²æ˜ å°„
 */
function generateOrcaColorMapping(variant: ThemeVariant): string {
  const colors = colorVariants[variant];
  
  return `
    /* Orca å˜é‡è¦†ç›–ï¼Œä½¿ç”¨ Tokyo Night é¢œè‰² */
    --orca-color-bg-0: ${colors.background.primary};
    --orca-color-bg-1: ${colors.background.secondary};
    --orca-color-bg-2: ${colors.background.tertiary};
    
    --orca-color-text-0: ${colors.text.primary};
    --orca-color-text-1: ${colors.text.secondary};
    --orca-color-text-2: ${colors.text.muted};
    
    --orca-color-primary-5: ${colors.semantic.blue};
    --orca-color-success-5: ${colors.semantic.green};
    --orca-color-warn-5: ${colors.semantic.orange};
    --orca-color-dangerous-5: ${colors.semantic.red};
    --orca-color-info-5: ${colors.semantic.cyan};
    
    --orca-color-border: ${colors.ui.border};
    --orca-color-hover: ${colors.ui.hover};
    --orca-color-selection: ${colors.ui.selection};`;
}

/**
 * ä¸ºæŒ‡å®šå˜ä½“ç”Ÿæˆå®Œæ•´çš„é™æ€ CSS å†…å®¹
 */
function generateVariantCSS(variant: ThemeVariant): string {
  console.log(`æ­£åœ¨ç”Ÿæˆ ${variant} å˜ä½“çš„ CSS...`);
  
  const customProperties = generateCSSCustomProperties(variant);
  const orcaMapping = generateOrcaColorMapping(variant);
  
  const fullCSS = `/*
 * Tokyo Night Theme - ${variant.charAt(0).toUpperCase() + variant.slice(1)} Variant
 * 
 * æ­¤æ–‡ä»¶ç”±æ„å»ºè„šæœ¬è‡ªåŠ¨ç”Ÿæˆï¼Œè¯·å‹¿æ‰‹åŠ¨ç¼–è¾‘ã€‚
 * Generated by: scripts/generateStaticCSS.ts
 * Variant: ${variant}
 * Generated at: ${new Date().toISOString()}
 */

:root {${customProperties}
${orcaMapping}
}

/* ========== åŸºç¡€æ ·å¼ ========== */

/* ç¼–è¾‘å™¨åŒºåŸŸ - æœ€é«˜è§†è§‰ä¼˜å…ˆçº§ */
.orca-editor,
.orca-note-editor,
.orca-markdown-editor {
    background-color: var(--tokyo-night-bg-primary) !important;
    color: var(--tokyo-night-text-primary) !important;
    /* ç¡®ä¿ç¼–è¾‘å™¨å…·æœ‰æœ€é«˜çš„è§†è§‰æƒé‡ */
    position: relative;
    z-index: 1;
}

/* ä¾§è¾¹æ  - é™ä½è§†è§‰æƒé‡ */
nav#sidebar,
.orca-sidebar {
    background-color: var(--tokyo-night-bg-secondary) !important;
    color: var(--tokyo-night-text-secondary) !important;
    border-right: 1px solid var(--tokyo-night-border) !important;
    /* å‡å°‘ä¾§è¾¹æ çš„è§†è§‰çªå‡ºåº¦ */
    opacity: 0.95;
    box-shadow: none !important;
}

/* ä¾§è¾¹æ é¡¹ç›®çš„æ‚¬åœæ•ˆæœ */
nav#sidebar .orca-sidebar-item:hover,
.orca-sidebar .orca-sidebar-item:hover {
    background-color: var(--tokyo-night-hover) !important;
    color: var(--tokyo-night-text-primary) !important;
    /* å¾®å¦™çš„æ‚¬åœåé¦ˆ */
    transition: all 0.2s ease;
}

/* ä¾§è¾¹æ é€‰ä¸­é¡¹ç›® */
nav#sidebar .orca-sidebar-item.selected,
.orca-sidebar .orca-sidebar-item.selected {
    background-color: var(--tokyo-night-selection) !important;
    color: var(--tokyo-night-text-primary) !important;
    border-left: 3px solid var(--tokyo-night-blue) !important;
}

/* ========== UI ç»„ä»¶æ ·å¼ ========== */

/* æŒ‰é’®æ ·å¼ */
.orca-button {
    border-radius: 6px !important;
    font-weight: 500 !important;
    transition: all 0.2s ease !important;
}

.orca-button.primary {
    background-color: var(--tokyo-night-blue) !important;
    color: var(--tokyo-night-bg-primary) !important;
    border-color: var(--tokyo-night-blue) !important;
}

.orca-button.primary:hover {
    filter: brightness(1.1) !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 2px 8px var(--tokyo-night-blue)44 !important;
}

/* è¾“å…¥æ¡†æ ·å¼ */
.orca-input,
.orca-textarea {
    background-color: var(--tokyo-night-bg-primary) !important;
    border: 1px solid var(--tokyo-night-border) !important;
    border-radius: 6px !important;
    color: var(--tokyo-night-text-primary) !important;
    transition: border-color 0.2s ease, box-shadow 0.2s ease !important;
}

.orca-input:focus,
.orca-textarea:focus {
    border-color: var(--tokyo-night-focus) !important;
    box-shadow: 0 0 0 2px var(--tokyo-night-focus)33 !important;
    outline: none !important;
}

/* æ¨¡æ€æ¡†æ ·å¼ */
.orca-modal {
    background-color: var(--tokyo-night-bg-tertiary) !important;
    color: var(--tokyo-night-text-primary) !important;
    border: 1px solid var(--tokyo-night-border) !important;
    border-radius: 8px !important;
    box-shadow: 0 12px 32px rgba(0,0,0,0.4) !important;
}

/* è¡¨æ ¼æ ·å¼ */
.orca-table {
    background-color: var(--tokyo-night-bg-primary) !important;
    border: 1px solid var(--tokyo-night-border) !important;
    border-radius: 6px !important;
}

.orca-table-header {
    background-color: var(--tokyo-night-bg-secondary) !important;
    color: var(--tokyo-night-text-primary) !important;
    border-bottom: 1px solid var(--tokyo-night-border) !important;
    font-weight: 600 !important;
}

.orca-table-row:hover {
    background-color: var(--tokyo-night-hover) !important;
}

/* ========== è¯­ä¹‰é¢œè‰²åº”ç”¨ ========== */

/* é”™è¯¯çŠ¶æ€ */
.orca-error,
.error {
    color: var(--tokyo-night-red) !important;
    border-color: var(--tokyo-night-red) !important;
}

/* æˆåŠŸçŠ¶æ€ */
.orca-success,
.success {
    color: var(--tokyo-night-green) !important;
    border-color: var(--tokyo-night-green) !important;
}

/* è­¦å‘ŠçŠ¶æ€ */
.orca-warning,
.warning {
    color: var(--tokyo-night-orange) !important;
    border-color: var(--tokyo-night-orange) !important;
}

/* ä¿¡æ¯çŠ¶æ€ */
.orca-info,
.info {
    color: var(--tokyo-night-cyan) !important;
    border-color: var(--tokyo-night-cyan) !important;
}

/* ========== æ’ç‰ˆå¢å¼º ========== */

/* ä»£ç å— */
code,
.orca-code {
    background-color: var(--tokyo-night-bg-secondary) !important;
    color: var(--tokyo-night-text-primary) !important;
    border: 1px solid var(--tokyo-night-border) !important;
    border-radius: 4px !important;
    padding: 0.2em 0.4em !important;
    font-family: 'Fira Code', 'Monaco', 'Consolas', monospace !important;
}

/* é“¾æ¥ */
a,
.orca-link {
    color: var(--tokyo-night-blue) !important;
    text-decoration: none !important;
    transition: color 0.2s ease !important;
}

a:hover,
.orca-link:hover {
    color: var(--tokyo-night-cyan) !important;
    text-decoration: underline !important;
}

/* ========== åŠ¨ç”»å’Œè¿‡æ¸¡ ========== */

/* å…¨å±€è¿‡æ¸¡æ•ˆæœ */
* {
    transition-duration: 0.2s !important;
    transition-timing-function: ease !important;
}

/* ç„¦ç‚¹æŒ‡ç¤ºå™¨ */
*:focus-visible {
    outline: 2px solid var(--tokyo-night-focus) !important;
    outline-offset: 2px !important;
    border-radius: 4px !important;
}

/* ========== å“åº”å¼è®¾è®¡ ========== */

@media (max-width: 768px) {
    /* ç§»åŠ¨è®¾å¤‡ä¸Šçš„æ ·å¼è°ƒæ•´ */
    nav#sidebar,
    .orca-sidebar {
        opacity: 0.9 !important;
    }
}

/* ========== å¯è®¿é—®æ€§å¢å¼º ========== */

@media (prefers-contrast: high) {
    :root {
        --tokyo-night-border: ${variant === 'light' ? '#999999' : '#555555'} !important;
    }
}

@media (prefers-reduced-motion: reduce) {
    * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

/* ========== å˜ä½“ç‰¹å®šæ ‡è¯† ========== */

body[data-theme-variant="${variant}"] {
    /* å˜ä½“æ ‡è¯†ç¬¦ï¼Œç”¨äºè°ƒè¯•å’Œç‰¹å®šæ ·å¼ */
}
`;

  return fullCSS;
}

/**
 * å°† CSS å†…å®¹å†™å…¥æ–‡ä»¶
 */
function writeVariantCSSFile(variant: ThemeVariant, cssContent: string): void {
  const fileName = `theme-${variant}.css`;
  const filePath = join(publicDir, fileName);
  
  try {
    // ç¡®ä¿ public ç›®å½•å­˜åœ¨
    if (!existsSync(publicDir)) {
      mkdirSync(publicDir, { recursive: true });
    }
    
    // å†™å…¥ CSS æ–‡ä»¶
    writeFileSync(filePath, cssContent, 'utf8');
    console.log(`âœ… æˆåŠŸç”Ÿæˆ: ${fileName}`);
  } catch (error) {
    console.error(`âŒ å†™å…¥ ${fileName} å¤±è´¥:`, error);
    throw error;
  }
}

/**
 * ç”Ÿæˆæ‰€æœ‰å˜ä½“çš„é™æ€ CSS æ–‡ä»¶
 */
function generateAllVariantCSS(): void {
  console.log('ğŸ¨ å¼€å§‹ç”Ÿæˆ Tokyo Night ä¸»é¢˜çš„é™æ€ CSS æ–‡ä»¶...\n');
  
  const variants: ThemeVariant[] = ['night', 'storm', 'light'];
  
  let successCount = 0;
  let errorCount = 0;
  
  for (const variant of variants) {
    try {
      const cssContent = generateVariantCSS(variant);
      writeVariantCSSFile(variant, cssContent);
      successCount++;
    } catch (error) {
      console.error(`âŒ å¤„ç† ${variant} å˜ä½“æ—¶å‡ºé”™:`, error);
      errorCount++;
    }
  }
  
  console.log('\nğŸ“Š ç”Ÿæˆç»“æœ:');
  console.log(`âœ… æˆåŠŸ: ${successCount} ä¸ªæ–‡ä»¶`);
  console.log(`âŒ å¤±è´¥: ${errorCount} ä¸ªæ–‡ä»¶`);
  
  if (errorCount > 0) {
    console.error('\nâŒ éƒ¨åˆ†æ–‡ä»¶ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯');
    process.exit(1);
  } else {
    console.log('\nğŸ‰ æ‰€æœ‰é™æ€ CSS æ–‡ä»¶ç”Ÿæˆå®Œæˆï¼');
  }
}

/**
 * éªŒè¯ç”Ÿæˆçš„ CSS æ–‡ä»¶
 */
function validateGeneratedFiles(): void {
  console.log('\nğŸ” éªŒè¯ç”Ÿæˆçš„ CSS æ–‡ä»¶...');
  
  const variants: ThemeVariant[] = ['night', 'storm', 'light'];
  let validationErrors = 0;
  
  for (const variant of variants) {
    const fileName = `theme-${variant}.css`;
    const filePath = join(publicDir, fileName);
    
    if (!existsSync(filePath)) {
      console.error(`âŒ æ–‡ä»¶ä¸å­˜åœ¨: ${fileName}`);
      validationErrors++;
      continue;
    }
    
    try {
      const content = readFileSync(filePath, 'utf8');
      
      // åŸºæœ¬éªŒè¯ï¼šæ£€æŸ¥æ–‡ä»¶æ˜¯å¦åŒ…å«å¿…è¦çš„å†…å®¹
      const requiredPatterns = [
        /Tokyo Night Theme/,
        /--tokyo-night-/,
        /:root/,
        new RegExp(`${variant}`, 'i')
      ];
      
      for (const pattern of requiredPatterns) {
        if (!pattern.test(content)) {
          console.error(`âŒ ${fileName} ç¼ºå°‘å¿…è¦å†…å®¹: ${pattern}`);
          validationErrors++;
        }
      }
      
      console.log(`âœ… ${fileName} éªŒè¯é€šè¿‡`);
    } catch (error) {
      console.error(`âŒ è¯»å– ${fileName} æ—¶å‡ºé”™:`, error);
      validationErrors++;
    }
  }
  
  if (validationErrors > 0) {
    console.error(`\nâŒ éªŒè¯å¤±è´¥ï¼Œå‘ç° ${validationErrors} ä¸ªé”™è¯¯`);
    process.exit(1);
  } else {
    console.log('\nâœ… æ‰€æœ‰æ–‡ä»¶éªŒè¯é€šè¿‡ï¼');
  }
}

// ä¸»æ‰§è¡Œé€»è¾‘
if (process.argv[1] && process.argv[1].includes('generateStaticCSS')) {
  try {
    generateAllVariantCSS();
    validateGeneratedFiles();
  } catch (error) {
    console.error('âŒ è„šæœ¬æ‰§è¡Œå¤±è´¥:', error);
    process.exit(1);
  }
}

// å¯¼å‡ºå‡½æ•°ä¾›æµ‹è¯•ä½¿ç”¨
export {
  generateVariantCSS,
  writeVariantCSSFile,
  generateAllVariantCSS,
  validateGeneratedFiles
};